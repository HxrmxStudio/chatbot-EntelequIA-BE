---
description: Refactored Clean Architecture layer boundaries and patterns
globs: ["src/**/*.ts"]
alwaysApply: false
---

# Refactored Architecture - WF1 Module

## Layer Structure

```
wf1/
  domain/           # Pure logic, no framework deps
    errors/         # MissingAuthForOrdersError, ExternalServiceError
    products-context/  # types.ts, constants.ts, summary.ts, match.ts, stock-visibility.ts, index.ts
    orders-context/    # types.ts, constants.ts, format.ts, index.ts
    payment-shipping-context/  # types.ts, constants.ts, format.ts, index.ts
    recommendations-context/  # types.ts, constants.ts, format.ts, filter.ts, index.ts
    general-context/         # types.ts, constants.ts, format.ts, index.ts
    store-info-context/     # types.ts, constants.ts, format.ts, index.ts
    tickets-context/        # types.ts, constants.ts, format.ts, index.ts
    money/          # types.ts, parse.ts, format.ts, index.ts (shared domain concept)
    intent/         # types.ts, constants.ts, index.ts
    intent-routing/ # types.ts, resolve.ts, index.ts
    text-policy/    # constants.ts, index.ts
    context-block/  # types.ts, render.ts, append-static-context.ts, index.ts
    user/           # types.ts, index.ts
    wf1-response/   # types.ts, index.ts
    ui-payload/     # types.ts, constants.ts, build-catalog-ui.ts, index.ts
    conversation-history/  # types.ts, constants.ts, map.ts, index.ts
    output-validation/     # types.ts, constants.ts, sentiment.ts, index.ts
    prepare-conversation-query/  # types.ts, build-query.ts, index.ts
    text-sanitizer/ # sanitize.ts, index.ts
    source/         # index.ts
    # Each concept in its own folder with index.ts as public API
  application/
    ports/          # Interfaces only, Symbol tokens
    use-cases/      # Orchestrate ports, inject via tokens
      handle-incoming-message/  # handle-incoming-message.use-case.ts, error-mapper.ts, check-if-authenticated.ts, orders-unauthenticated-response.ts, orders-order-lookup-response.ts, resolve-order-lookup-request.ts, resolve-order-lookup-flow-state.ts, index.ts; User resolution: resolveUserContext uses EntelequiaContextPort.getAuthenticatedUserProfile and ChatPersistencePort.upsertAuthenticatedUserProfile when Bearer token is present and valid; otherwise guest via upsertUser. Conversation, history, persistTurn, and audit use effectiveUserId.
      enrich-context-by-intent/  # enrich-context-by-intent.use-case.ts, query-resolvers/ (types, patterns, normalize, clean-entities, detect-category, resolve-products, resolve-order, resolve-payment-shipping-query-type, resolve-recommendations-preferences, recommendation-type-slugs, resolve-store-info-query-type, resolve-ticket-signals, resolve-stock-disclosure, category-slugs, index); ResolvedProductsQuery includes categorySlug for Entelequia filtering; product-parsers.ts, order-parsers.ts, payment-info-parsers.ts, recommendation-parsers.ts, index.ts
      # Each use case in its own folder with index.ts as public API
  infrastructure/
    adapters/       # OpenAI, Entelequia, IntentExtractor, PromptTemplates
      shared/       # prompt-loader.ts, http-client.ts, schema-loader.ts (DRY helpers)
      openai-retry/ # withRetry utility
      intent-validator/ # IntentValidationError, validateAndNormalizeIntentPayload
      openai/       # openai.adapter.ts, endpoints.ts, openai-client.ts, prompt-builder.ts, fallback-builder.ts, constants.ts, errors.ts, retry-helpers.ts, types.ts, index.ts
      intent-extractor/  # intent-extractor.adapter.ts, endpoints.ts, openai-client.ts, text-helpers.ts, response-helpers.ts, constants.ts, index.ts
      entelequia-http/   # entelequia-http.adapter.ts, endpoints.ts, entelequia-client.ts, payload-normalizers.ts, product-helpers.ts, entelequia-order-lookup.client.ts, bot-hmac-signer.ts, base-url.ts, index.ts
      prompt-templates/  # prompt-templates.adapter.ts, constants.ts, index.ts (centralizes all prompt loading)
      metrics/           # prometheus-metrics.adapter.ts (Prometheus metrics; optional index.ts as public API)
      rate-limit/        # redis-order-lookup-rate-limiter.adapter.ts, index.ts
      # Each adapter in its own folder with index.ts as public API
      # endpoints.ts centralizes all endpoint definitions (API endpoints and web frontend URLs like productWebUrl, storageImageUrl) for better maintainability
    repositories/   # PgChat, PgIdempotency, PgAudit (share PG_POOL)
      shared/       # json-helpers.ts (toJsonb for jsonb columns)
    security/       # Guards, validation, sanitization
      services/     # All security services grouped here (NestJS best practice)
        signature-validation/  # signature-validation.service.ts, web-signature-validator.ts, whatsapp-signature-validator.ts, index.ts
        turnstile-verification/  # turnstile-verification.service.ts, turnstile-client.ts, index.ts
        input-validation/  # input-validation.service.ts, field-validators.ts, index.ts
        extract-variables/  # extract-variables.service.ts, field-extractor.ts, index.ts
        text-sanitizer/  # text-sanitizer.ts, index.ts
        # Each service in its own folder with index.ts as public API
      shared/       # string-helpers.ts, crypto-helpers.ts, body-helpers.ts (DRY helpers)
      # Guards remain in root: signature.guard.ts, input-validation.guard.ts, extract-variables.guard.ts
  controllers/  # chat.controller.ts, metrics.controller.ts, resolve-access-token.ts (Bearer token only, body accessToken rejected)
  dto/
```

## Dependency Rule

- Domain: zero imports from app/infra
- Use cases: import ports (interfaces), domain, NOT infrastructure
- Adapters: implement ports, import domain
- Controllers: import use cases, DTOs, guards

## Port Tokens

Defined in `application/ports/tokens.ts`:
- INTENT_EXTRACTOR_PORT, ENTELEQUIA_CONTEXT_PORT, LLM_PORT
- PROMPT_TEMPLATES_PORT (for centralized prompt access)
- METRICS_PORT (for Prometheus metrics)
- ORDER_LOOKUP_RATE_LIMITER_PORT (for order lookup rate limiting)
- CHAT_PERSISTENCE_PORT, IDEMPOTENCY_PORT, AUDIT_PORT
- PG_POOL (for repository implementations)

## Repository Split

- PgChatRepository: ChatPersistencePort
- PgIdempotencyRepository: IdempotencyPort
- PgAuditRepository: AuditPort
- All inject PG_POOL from PgPoolProvider

## Shared Utilities

- `src/common/utils/string.utils.ts`: resolveOptionalString (consolidated from security/shared)
- `src/common/utils/date.utils.ts`: coerceTimestamp (moved from pg-chat.repository.ts)
- `src/common/utils/object.utils.ts`: ensureObject, isRecord
- `src/common/utils/logger.ts`: createLogger (with automatic PII redaction via pii-redaction.ts)
- `src/common/utils/pii-redaction.ts`: redactSensitiveData (redacts PII from logs/metrics)
- `infrastructure/adapters/openai-retry.client.ts`: withRetry
- `infrastructure/repositories/shared/json-helpers.ts`: toJsonb (for PostgreSQL jsonb columns)
- `domain/money/`: parseMoney, formatMoney (shared domain concept for products and orders)
- `src/common/metrics/`: metric names and categories (shared across WF1 metrics adapter and use cases)

## Domain Errors

- `MissingAuthForOrdersError`: orders intent without accessToken
- `ExternalServiceError`: Entelequia/LLM failures (statusCode, errorCode)

## Validation Flow

- Guard pipeline: SignatureGuard → InputValidationGuard → ExtractVariablesGuard
- ChatRequestDto is an interface; validation via guards, not class-validator
- Controllers build payload from request.extractedVariables

## Externalized Prompts

All prompts and instructions are externalized to `prompts/` for versioning and maintainability. Prompts are organized in subfolders by domain: `prompts/system/` (intent, assistant), `prompts/products/`, `prompts/orders/`, `prompts/payment-shipping/`, `prompts/recommendations/`, `prompts/tickets/`, `prompts/store-info/`, `prompts/general/`, `prompts/static/`, `prompts/eval/`. Full paths are centralized in `adapters/prompt-templates/constants.ts`.

**Prompt Loading Pattern**:
- Use `PromptTemplatesPort` (via `PROMPT_TEMPLATES_PORT` token) in use cases to access prompts
- `PromptTemplatesAdapter` loads all prompts synchronously in constructor
- All prompt paths and DEFAULT fallbacks are centralized in `adapters/prompt-templates/constants.ts`
- Version prompts with `_v1.txt`, `_v2.txt`, etc. for easy migration

**Legacy**: Some adapters (OpenAI, IntentExtractor) still load prompts directly using `loadPromptFile` from `adapters/shared` for their specific system prompts. This is acceptable for adapter-specific prompts.
