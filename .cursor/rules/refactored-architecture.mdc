---
description: Refactored Clean Architecture layer boundaries and patterns
globs: ["src/**/*.ts"]
alwaysApply: false
---

# Refactored Architecture - WF1 Module

## Layer Structure

```
wf1/
  domain/           # Pure logic, no framework deps
    errors/         # MissingAuthForOrdersError, ExternalServiceError
    products-context/  # types.ts, constants.ts, summary.ts, match.ts, index.ts
    money/          # types.ts, parse.ts, format.ts, index.ts (shared domain concept)
    intent/         # types.ts, constants.ts, index.ts
    intent-routing/ # types.ts, resolve.ts, index.ts
    text-policy/    # constants.ts, index.ts
    context-block/  # types.ts, render.ts, append-static-context.ts, index.ts
    user/           # types.ts, index.ts
    wf1-response/   # types.ts, index.ts
    conversation-history/  # types.ts, constants.ts, map.ts, index.ts
    output-validation/     # types.ts, constants.ts, sentiment.ts, index.ts
    prepare-conversation-query/  # types.ts, build-query.ts, index.ts
    text-sanitizer/ # sanitize.ts, index.ts
    source/         # index.ts
    # Each concept in its own folder with index.ts as public API
  application/
    ports/          # Interfaces only, Symbol tokens
    use-cases/      # Orchestrate ports, inject via tokens
      handle-incoming-message/  # handle-incoming-message.use-case.ts, error-mapper.ts, index.ts
      enrich-context-by-intent/  # enrich-context-by-intent.use-case.ts, query-resolvers/ (types, patterns, normalize, clean-entities, detect-category, resolve-products, resolve-order, index), product-parsers.ts, index.ts
      # Each use case in its own folder with index.ts as public API
  infrastructure/
    adapters/       # OpenAI, Entelequia, IntentExtractor, PromptTemplates
      shared/       # prompt-loader.ts, http-client.ts, schema-loader.ts (DRY helpers)
      openai-retry/ # withRetry utility
      intent-validator/ # IntentValidationError, validateAndNormalizeIntentPayload
      openai/       # openai.adapter.ts, endpoints.ts, openai-client.ts, prompt-builder.ts, fallback-builder.ts, index.ts
      intent-extractor/  # intent-extractor.adapter.ts, endpoints.ts, openai-client.ts, text-helpers.ts, response-helpers.ts, constants.ts, index.ts
      entelequia-http/   # entelequia-http.adapter.ts, endpoints.ts, entelequia-client.ts, payload-normalizers.ts, product-helpers.ts, index.ts
      prompt-templates/  # prompt-templates.adapter.ts, constants.ts, index.ts (centralizes all prompt loading)
      # Each adapter in its own folder with index.ts as public API
      # endpoints.ts centralizes all endpoint definitions (API endpoints and web frontend URLs like productWebUrl, storageImageUrl) for better maintainability
    repositories/   # PgChat, PgIdempotency, PgAudit (share PG_POOL)
      shared/       # json-helpers.ts (toJsonb for jsonb columns)
    security/       # Guards, validation, sanitization
      services/     # All security services grouped here (NestJS best practice)
        signature-validation/  # signature-validation.service.ts, web-signature-validator.ts, whatsapp-signature-validator.ts, index.ts
        turnstile-verification/  # turnstile-verification.service.ts, turnstile-client.ts, index.ts
        input-validation/  # input-validation.service.ts, field-validators.ts, index.ts
        extract-variables/  # extract-variables.service.ts, field-extractor.ts, index.ts
        text-sanitizer/  # text-sanitizer.ts, index.ts
        # Each service in its own folder with index.ts as public API
      shared/       # string-helpers.ts, crypto-helpers.ts, body-helpers.ts (DRY helpers)
      # Guards remain in root: signature.guard.ts, input-validation.guard.ts, extract-variables.guard.ts
  controllers/
  dto/
```

## Dependency Rule

- Domain: zero imports from app/infra
- Use cases: import ports (interfaces), domain, NOT infrastructure
- Adapters: implement ports, import domain
- Controllers: import use cases, DTOs, guards

## Port Tokens

Defined in `application/ports/tokens.ts`:
- INTENT_EXTRACTOR_PORT, ENTELEQUIA_CONTEXT_PORT, LLM_PORT
- PROMPT_TEMPLATES_PORT (for centralized prompt access)
- CHAT_PERSISTENCE_PORT, IDEMPOTENCY_PORT, AUDIT_PORT
- PG_POOL (for repository implementations)

## Repository Split

- PgChatRepository: ChatPersistencePort
- PgIdempotencyRepository: IdempotencyPort
- PgAuditRepository: AuditPort
- All inject PG_POOL from PgPoolProvider

## Shared Utilities

- `src/common/utils/string.utils.ts`: resolveOptionalString (consolidated from security/shared)
- `src/common/utils/date.utils.ts`: coerceTimestamp (moved from pg-chat.repository.ts)
- `src/common/utils/object.utils.ts`: ensureObject, isRecord
- `infrastructure/adapters/openai-retry.client.ts`: withRetry
- `infrastructure/repositories/shared/json-helpers.ts`: toJsonb (for PostgreSQL jsonb columns)
- `domain/money/`: parseMoney, formatMoney (shared domain concept for products and orders)

## Domain Errors

- `MissingAuthForOrdersError`: orders intent without accessToken
- `ExternalServiceError`: Entelequia/LLM failures (statusCode, errorCode)

## Validation Flow

- Guard pipeline: SignatureGuard → InputValidationGuard → ExtractVariablesGuard
- ChatRequestDto is an interface; validation via guards, not class-validator
- Controllers build payload from request.extractedVariables

## Externalized Prompts

All prompts and instructions are externalized to `prompts/` for versioning and maintainability:

- `prompts/entelequia_intent_system_prompt_v1.txt` - Intent classification system prompt
- `prompts/entelequia_assistant_system_prompt_v1.txt` - Assistant system prompt
- `prompts/entelequia_products_context_header_v1.txt` - Products context header
- `prompts/entelequia_products_context_additional_info_v1.txt` - Additional store information
- `prompts/entelequia_products_context_instructions_v1.txt` - Instructions for product responses
- `prompts/entelequia_general_context_hint_v1.txt` - General context hint
- `prompts/entelequia_static_context_v1.txt` - Static business context (stores, contact, etc.)

**Prompt Loading Pattern**:
- Use `PromptTemplatesPort` (via `PROMPT_TEMPLATES_PORT` token) in use cases to access prompts
- `PromptTemplatesAdapter` loads all prompts synchronously in constructor
- All prompt paths and DEFAULT fallbacks are centralized in `adapters/prompt-templates/constants.ts`
- Version prompts with `_v1.txt`, `_v2.txt`, etc. for easy migration

**Legacy**: Some adapters (OpenAI, IntentExtractor) still load prompts directly using `loadPromptFile` from `adapters/shared` for their specific system prompts. This is acceptable for adapter-specific prompts.
