---
description: Security, signature validation, secret handling, and safe error output rules
globs: ["src/modules/wf1/infrastructure/security/**/*.ts", "src/common/**/*.ts", "src/main.ts", "src/modules/wf1/controllers/**/*.ts", "src/modules/wf1/application/use-cases/**/*.ts", ".env.example", "README.md"]
alwaysApply: false
---

# Security and Secrets Rules

## Secret handling

- Never hardcode API keys, webhook secrets, or credentials.
- Never print raw secret values in logs or responses.
- Do not log full `accessToken` values.
- Keep `.env` out of versioned commits and maintain `.env.example` as template only.

## Signature validation

- Preserve web signature behavior via `x-webhook-secret` when `WEBHOOK_SECRET` is configured.
- Preserve WhatsApp signature behavior via `x-hub-signature-256` HMAC with raw body when `WHATSAPP_SECRET` is configured.
- Reject invalid signatures with safe unauthorized responses.

## Input safety

- Sanitize user `text` before intent extraction, enrichment, LLM calls, and persistence.
- Reject empty sanitized payloads as invalid requests.
- Keep request body size limits explicit.

## Response safety

- Never leak stack traces or internal details to clients.
- Use safe, user-facing fallback messages for internal failures.
- Keep global exception mapping consistent via existing exception filter.

## Traceability and headers

- Preserve `x-request-id` propagation.
- Include request context in logs without exposing sensitive data.

## CORS and exposure

- Keep CORS restricted by `ALLOWED_ORIGINS`.
- Do not loosen CORS defaults without explicit requirement.
